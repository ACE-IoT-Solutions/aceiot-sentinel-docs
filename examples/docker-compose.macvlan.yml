version: '3.8'

# MACVLAN Network Mode (Recommended for Production)
# This gives the container its own MAC address and IP on your physical network.
# Best for production deployments requiring network isolation.
#
# Advantages:
# - Full network isolation
# - Container gets its own IP address
# - No port conflicts
# - BACnet broadcasts work perfectly
# - Multiple containers can coexist
#
# Prerequisites:
# 1. Create MACVLAN network first:
#    docker network create -d macvlan \
#      --subnet=192.168.1.0/24 \
#      --gateway=192.168.1.1 \
#      --ip-range=192.168.1.128/25 \
#      -o parent=eth0 \
#      sentinel-macvlan
#
# 2. Copy .env.example to .env
# 3. Edit BACNET_ADDRESS to match the static IP below
# 4. Run: docker-compose -f docker-compose.macvlan.yml up -d
#
# Note: Replace 'eth0' with your network interface name
#       Use 'ip addr show' to find your interface

networks:
  macvlan:
    external: true
    name: sentinel-macvlan

services:
  sentinel:
    image: ghcr.io/ace-iot-solutions/aceiot-sentinel:latest
    container_name: aceiot-sentinel

    networks:
      macvlan:
        # CHANGE THIS: Set a static IP from your container IP range
        ipv4_address: 192.168.1.150

    environment:
      # CHANGE THIS: Must match the IP address above
      BACNET_ADDRESS: 192.168.1.150/24:47808

      # Optional: Override other settings
      BACNET_NAME: "Sentinel"
      BACNET_INSTANCE: 999
      VOLTTRON_INSTANCE_NAME: sentinel-edge
      WEBAPP_ENABLED: true
      WEBAPP_PORT: 5000
      SCAN_INTERVAL_SECS: 86400

    # Or use env_file for all configuration
    # env_file:
    #   - .env

    volumes:
      # Persist VOLTTRON data
      - volttron-data:/home/volttron/.aceiot-sentinel-volttron

      # Optional: Mount SSL certificates
      # - ./certs:/certs:ro

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  volttron-data:
    driver: local
